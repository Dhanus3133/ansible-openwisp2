---

- name: Converge
  hosts: all
  become: true

  vars:
    openwisp2_network_topology: true
    openwisp2_firmware_upgrader: true
    openwisp2_radius: true
    openwisp2_controller_subnet_division: true
    openwisp2_uwsgi_extra_conf: |
      single-interpreter=True
    openwisp2_usage_metric_collection: false
    openwisp2_extra_python_packages:
      - selenium
    freeradius_eap_orgs:
      - name: openwisp
        uuid: 00000000-0000-0000-0000-000000000000
        radius_token: secret-radius-token
        auth_port: 1822
        acct_port: 1823
        inner_tunnel_auth_port: 18230

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 600
      when: ansible_os_family == 'Debian'

    - name: Install Selenium dependencies on Debian 11 (manual geckodriver)
      block:
        - name: Install Firefox and XVFB from apt
          apt:
            name: ['firefox-esr', 'xvfb']
            state: present

        - name: Download and unarchive latest geckodriver
          ansible.builtin.unarchive:
            src: "https://github.com/mozilla/geckodriver/releases/download/v0.36.0/geckodriver-v0.36.0-linux64.tar.gz"
            dest: "/tmp/"
            remote_src: true

        - name: Move geckodriver to a directory in PATH
          ansible.builtin.copy:
            src: "/tmp/geckodriver"
            dest: "/usr/local/bin/geckodriver"
            remote_src: true
            mode: '0755'
      when: ansible_distribution == 'Debian' and ansible_distribution_major_version == '11'

    - name: Install Selenium dependencies on other systems (from apt)
      vars:
        _firefox_package_name: "{{ 'firefox-esr' if ansible_distribution == 'Debian' else 'firefox' }}"
      apt:
        name:
          - "{{ _firefox_package_name }}"
          - geckodriver
          - xvfb
        state: present
      when: not (ansible_distribution == 'Debian' and ansible_distribution_major_version == '11')

    - name: Install net-tools
      apt:
        name:
        - net-tools

    - name: Remove the .dockerenv file
      file:
        path: /.dockerenv
        state: absent

  roles:
    - role: openwisp.openwisp2
